<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Emacs 中的时间计算</title>
<!-- 2013-09-09 一 16:28 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />


<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../../css/worg.css" />
<link rel="alternate stylesheet" type="text/css" href="../../../css/worg-zenburn.css" />
<link rel="alternate stylesheet" type="text/css" href="../../../css/worg-classic.css" />

<script type="text/javascript" src="org-info.js">
/**
 *
 * @source: org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in org-info.js.
 *
 * Copyright (C) 2012-2013  Sebastian Rose
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "../../../index.html");
org_html_manager.set("LINK_UP", "../../index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../../index.html"> UP </a>
 |
 <a accesskey="H" href="../../../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Emacs 中的时间计算</h1>
<p>
我每天都要面对 Emacs 好多个小时，也逐渐熟悉了它的许多特性，其中之一就是时间的计
算。我们可以在 Python 中很方便地使用 <code>time</code> 模块进行日期计算，新的 C++11 中引入
的 <code>std::chrono</code> 让时间计算也很简洁，当然，这些对于成熟的 Emacs Lisp 来说，更不
是问题。
</p>

<p>
时间包含两部分内容，一个是时间长度——时、分、秒，一个是时间点——某年某月某日。如果
要编写一段小程序，在每天可以自动显示儿子成长的时间，就需要把他出生的时间点作为参
数，自动提取当前时间进行计算即可。如何实现呢？
</p>

<p>
Emacs Lisp 中的时间结构如下:
</p>
<pre class="example">
`(SEC-HIGH SEC-LOW MICROSEC PICOSEC)
</pre>
<p>
后面的两个值可依次省略。浮点时间以秒为单位，计算公式如下：
</p>
<ul class="org-ul">
<li>t = <code>SEC-HIGH</code> * 2**16 + <code>SEC-LOW</code> + <code>MICROSEC</code> * 1e-6 + <code>PICOSEC</code> * 1e-9
</li>
</ul>

<p>
Emacs Lisp 中有关时间操作的基本函数有：
</p>
<ul class="org-ul">
<li><code>current-time-string &amp;optional time-value</code>
</li>
<li><code>current-time</code>
</li>
<li><code>float-time &amp;optional time-value</code>
</li>
<li><code>current-time-zone &amp;optional time-value</code>
</li>
</ul>

<p>
Emacs 中进行时间计算的基本函数:
</p>
<ul class="org-ul">
<li><code>decode-time &amp;optional time</code> &#x2013; 时间编码，将 time 值转换成历法信息。
</li>
<li><code>encode-time seconds minutes hour day month year &amp;optional zone</code> &#x2013; 时间解码，
与 <code>decode-time</code> 功能相反。
</li>
<li><code>date-to-time string</code>
</li>
<li><code>format-time-string format-string &amp;optional time universal</code>, libc
</li>
<li><code>seconds-to-time seconds</code>
</li>
<li><code>format-seconds format-string seconds</code>
</li>
</ul>

<p>
对于日历计算，在 Emacs 内部转换始终使用格里高利历，历法日期包含九项内容：
</p>
<pre class="example">
(SECONDS MINUTES HOUR DAY MONTH YEAR DOW DST ZONE)
</pre>
<p>
其中:
</p>
<ul class="org-ul">
<li><code>SECONDS</code>, <code>MINUTES</code>, <code>HOUR</code>, <code>DAY</code>, <code>MONTH</code>, <code>YEAR</code> 意思不用多说了。
</li>
<li><code>DOW</code>, 指的是 the day of week, 即每周的第几天，其中 0 表示周日。
</li>
<li><code>DST</code>, 即 daylight saving time, 夏令时修正
</li>
<li><code>ZONE</code>, 指的是时区，即与格林威治时间相关的秒数。
</li>
</ul>
<p>
上述内容除了 <code>DAY</code> 与 <code>MONTH</code> 外，均从 0 开始计数。特别注意的是: 0 年表示 1
B.C., 因此 -37 则表示公元前 38 年。
</p>

<p>
除了公历外, Emacs 还支持犹太历、伊斯兰历、玛雅历等，当然包括中国的农历。
</p>

<p>
那么，计算成长时间的方法就很简单了，相应的 elisp 程序如下：
</p>
<div class="org-src-container">

<pre class="src src-elisp">(setq lubo-birth-time (encode-time 0 50 8 12 12 2011)) <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">&#20986;&#29983;&#26085;&#26399;</span>
(setq the-date-time (current-time)) <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">&#24403;&#21069;&#26102;&#38388;</span>
(setq life-time (time-subtract the-date-time lubo-birth-time)) <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">&#26102;&#38388;&#24046;</span>
(format-seconds <span style="color: #b9ca4a;">"%Y, %D, %H, %M%z"</span> (float-time life-time))
</pre>
</div>

<p>
其实，一天严格来说并不是 86400 秒，一年也不是严格的 365 天，因此，在计算日期差时，
可以更精确一些。可以定义了一个函数，用于交互式显示成长日期：
</p>
<div class="org-src-container">

<pre class="src src-elisp"><span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">&#26174;&#31034;&#20799;&#23376;&#30340;&#25104;&#38271;&#26102;&#38388;</span>
(<span style="color: #c397d8;">defun</span> <span style="color: #7aa6da;">lubo-live-time</span> ()
  <span style="color: #969896;">"Display the live time of my son."</span>
  (interactive)
  (<span style="color: #c397d8;">let*</span>
      ((birth-time (encode-time 0 50 8 12 12 2011))
       (live-time  (time-subtract (current-time) birth-time))
       (lt-secs    (float-time live-time)))
    (message
     (format <span style="color: #b9ca4a;">"Lubo: %d days; %.2f months; %.2f weeks; -- %s"</span>
             (floor (/ lt-secs 86400))
             (/ lt-secs 2628000) <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">1 y = 12 m, 1 m ~= 30.4166667 d</span>
             (/ lt-secs 604800)
             (format-seconds <span style="color: #b9ca4a;">"%Y, %D, %H, %M%z"</span> lt-secs)
             ))))
</pre>
</div>

<p>
把上述代码添加到 <code>.emacs</code> 中，这样，随时想到儿子，我按一下 <code>M-x lubo-live-time</code>
命令，就可以很开心地看到一串字符了：
</p>
<pre class="example">
Lubo: 637 days; 20.95 months; 91.04 weeks; -- 1 year, 272 days, 7 hours, 33 minutes
</pre>
</div>
<div id="postamble" class="status">
<div id="disqus_thread"></div>
<p>版权所有 ©2013: 心蛛 | Date: <span class="timestamp-wrapper"><span class="timestamp">[2013-09-09 一]</span></span> | Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.50.1 (<a href="http://orgmode.org">Org</a> mode 8.0.7), <a href="http://validator.w3.org/check?uri=referer">Validate</a>, <a href="http://creativecommons.org/licenses/by-nc-sa/2.5/"><img src="http://i.creativecommons.org/l/by-nc-sa/2.5/cn/88x31.png" alt="88x31.png"/></a></p>
<script type="text/javascript">
  var disqus_shortname = 'exaos-github';
  (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</p>
</div>
</body>
</html>